name: Golden Keyword Miner Cron

on:
  schedule:
    - cron: '*/5 * * * *' # Run every 5 minutes (UTC) - Í≥µÍ≤©Ï†Å Î™®Îìú
  workflow_dispatch: # Allow manual trigger

jobs:
  mine:
    runs-on: ubuntu-latest
    timeout-minutes: 2 # ÏµúÎåÄ 2Î∂Ñ (120Ï¥à) Ï†úÌïú
    
    steps:
      - name: Trigger Miner API
        id: mining
        run: |
          set -e  # ÏóêÎü¨ Ïãú Ï¶âÏãú Ï§ëÎã®
          
          # ÌôòÍ≤Ω Î≥ÄÏàò Í≤ÄÏ¶ù
          if [ -z "${{ secrets.PROD_URL }}" ] || [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ùå ERROR: PROD_URL or CRON_SECRET is not set in GitHub Secrets."
            exit 1
          fi
          
          START_TIME=$(date +%s)
          echo "üöÄ Starting mining batch at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          
          # API Ìò∏Ï∂ú with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "üì° Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            # curlÎ°ú API Ìò∏Ï∂ú
            RESPONSE=$(curl -X GET "${{ secrets.PROD_URL }}/api/miner/execute" \
              -H "CRON_SECRET: ${{ secrets.CRON_SECRET }}" \
              -w "\n%{http_code}" \
              --max-time 70 \
              --silent \
              --show-error) || true
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "200" ]; then
              SUCCESS=true
              echo "‚úÖ Success! HTTP $HTTP_CODE"
              echo "üìä Response:"
              echo "$BODY" | jq '.' || echo "$BODY"
            else
              echo "‚ö†Ô∏è  Failed with HTTP $HTTP_CODE"
              echo "Response: $BODY"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((RETRY_COUNT * 5))
                echo "‚è≥ Waiting ${WAIT_TIME}s before retry..."
                sleep $WAIT_TIME
              fi
            fi
          done
          
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          if [ "$SUCCESS" = "false" ]; then
            echo "‚ùå Failed after $MAX_RETRIES attempts (${DURATION}s)"
            exit 1
          fi
          
          echo "‚è±Ô∏è  Total execution time: ${DURATION} seconds"
          echo "üéâ Mining batch completed successfully!"

